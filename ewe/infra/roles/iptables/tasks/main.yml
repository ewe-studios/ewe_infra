---
# tasks file for iptables
- name: uninstall ufw if installed
  package:
    purge: true
    state: absent
    pkg:
      - ufw
- name: install iptables
  package:
    state: present
    pkg:
      - iptables
      - iptables-persistent
- name: Set up default iptables rules
  ansible.builtin.command: "{{item}}"
  loop:
    - "iptables -A INPUT -s 127.0.0.1/32 -j ACCEPT"
    - "iptables -A INPUT -i en0 -j ACCEPT"
    - "iptables -A INPUT -i eth0 -j ACCEPT"
    - "iptables -A INPUT -i enp3s0f0 -j ACCEPT"
    - "iptables -A INPUT -i {{ infra.device.iface }} -j ACCEPT"
    - "iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT"
    - "iptables -A INPUT -m state --state NEW -m iprange --src-range 192.168.128.1-192.168.128.254 -j ACCEPT"
    - "iptables -A INPUT -m state --state ESTABLISHED,RELATED -m iprange --src-range 192.168.128.1-192.168.128.254 -j ACCEPT"
    - "iptables -A INPUT -m iprange --src-range 192.168.128.1-192.168.128.254 -p all -j ACCEPT"
    - "iptables -A INPUT -m iprange --src-range 192.168.128.1-192.168.128.254 -p tcp --dport 5606 -j ACCEPT"
    - "iptables -A INPUT -p udp --dport 5443 -j ACCEPT"
    - "iptables -A INPUT -p tcp --dport 5443 -j ACCEPT"
    - "iptables -A INPUT -p tcp --dport 5606 -j ACCEPT"
    - "iptables -A INPUT -p udp --dport 5606 -j ACCEPT"
    - "iptables -A INPUT -p tcp --dport 80 -j ACCEPT"
    - "iptables -A INPUT -p tcp --dport 8080 -j ACCEPT"
    - "iptables -A INPUT -p tcp --dport 443 -j ACCEPT"
    - "iptables -A INPUT -j REJECT"
    - "iptables -A OUTPUT -j ACCEPT"
- name: Accept connection from localhost
  ansible.builtin.iptables:
    chain: INPUT
    in_interface: lo
    jump: ACCEPT
    state: present
- name: Accept connection from localhost
  ansible.builtin.iptables:
    chain: INPUT
    source: 127.0.0.0/24
    jump: ACCEPT
    state: present
- name: Accept connection out of localhost
  ansible.builtin.iptables:
    chain: OUTPUT
    out_interface: lo
    jump: ACCEPT
    state: present
- name: Accept connection from other interfaces
  ansible.builtin.iptables:
    chain: INPUT
    in_interface: "{{item}}"
    jump: ACCEPT
    state: present
  loop:
    - "eno"
    - "eth0"
    - "enp3s0f0"
- name: Accept connection from localhost
  ansible.builtin.iptables:
    chain: INPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT
    state: present
